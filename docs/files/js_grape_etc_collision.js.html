<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\grape\etc\collision.js - grape</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="grape"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Grape.html">Grape</a></li>
            
                <li><a href="../classes/Grape.AABB.html">Grape.AABB</a></li>
            
                <li><a href="../classes/Grape.AbstractView.html">Grape.AbstractView</a></li>
            
                <li><a href="../classes/Grape.Alarm.html">Grape.Alarm</a></li>
            
                <li><a href="../classes/Grape.Animation.html">Grape.Animation</a></li>
            
                <li><a href="../classes/Grape.Array.html">Grape.Array</a></li>
            
                <li><a href="../classes/Grape.Audio.html">Grape.Audio</a></li>
            
                <li><a href="../classes/Grape.Bag.html">Grape.Bag</a></li>
            
                <li><a href="../classes/Grape.Cacheable.html">Grape.Cacheable</a></li>
            
                <li><a href="../classes/Grape.Class.html">Grape.Class</a></li>
            
                <li><a href="../classes/Grape.Collidable.html">Grape.Collidable</a></li>
            
                <li><a href="../classes/Grape.CollisionSystem.html">Grape.CollisionSystem</a></li>
            
                <li><a href="../classes/Grape.Env.html">Grape.Env</a></li>
            
                <li><a href="../classes/Grape.EventEmitter.html">Grape.EventEmitter</a></li>
            
                <li><a href="../classes/Grape.Game.html">Grape.Game</a></li>
            
                <li><a href="../classes/Grape.GameLoop.html">Grape.GameLoop</a></li>
            
                <li><a href="../classes/Grape.GameObject.html">Grape.GameObject</a></li>
            
                <li><a href="../classes/Grape.GameObjectArray.html">Grape.GameObjectArray</a></li>
            
                <li><a href="../classes/Grape.GUIView.html">Grape.GUIView</a></li>
            
                <li><a href="../classes/Grape.Input.html">Grape.Input</a></li>
            
                <li><a href="../classes/Grape.JSONSceneSource.html">Grape.JSONSceneSource</a></li>
            
                <li><a href="../classes/Grape.Layer.html">Grape.Layer</a></li>
            
                <li><a href="../classes/Grape.Mouse.html">Grape.Mouse</a></li>
            
                <li><a href="../classes/Grape.Object.html">Grape.Object</a></li>
            
                <li><a href="../classes/Grape.Physical.html">Grape.Physical</a></li>
            
                <li><a href="../classes/Grape.Position.html">Grape.Position</a></li>
            
                <li><a href="../classes/Grape.Rectangle.html">Grape.Rectangle</a></li>
            
                <li><a href="../classes/Grape.Resource.html">Grape.Resource</a></li>
            
                <li><a href="../classes/Grape.ResourceCollection.html">Grape.ResourceCollection</a></li>
            
                <li><a href="../classes/Grape.Scene.html">Grape.Scene</a></li>
            
                <li><a href="../classes/Grape.Sprite.html">Grape.Sprite</a></li>
            
                <li><a href="../classes/Grape.SpriteVisualizer.html">Grape.SpriteVisualizer</a></li>
            
                <li><a href="../classes/Grape.System.html">Grape.System</a></li>
            
                <li><a href="../classes/Grape.TagContainer.html">Grape.TagContainer</a></li>
            
                <li><a href="../classes/Grape.Taggable.html">Grape.Taggable</a></li>
            
                <li><a href="../classes/Grape.Utils.html">Grape.Utils</a></li>
            
                <li><a href="../classes/Grape.View.html">Grape.View</a></li>
            
                <li><a href="../classes/Grape.Visualizer.html">Grape.Visualizer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js\grape\etc\collision.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([&#x27;../class&#x27;, &#x27;./aabb&#x27;, &#x27;../game/game-object&#x27;, &#x27;../game/system&#x27;], function (Class, AABB, GameObject, System) {

    Class.registerKeyword(&#x27;collision&#x27;, {
        onInit: function (classInfo) {
            classInfo.collisions = {};
            classInfo.allCollision = {};
        },
        onAdd: function (classInfo, methodDescriptor) {
            if (!classInfo.extends(Collidable)) {
                throw new Error(&#x27;To use &quot;collision&quot; keyword, inherit the Grape.Collidable class!&#x27;);
            }
            classInfo.collisions[methodDescriptor.name] = methodDescriptor.method;
        },
        onFinish: function (classInfo) {
            var parents = classInfo.allParent, colls = classInfo.allCollision, parentsAndMe = parents.concat(classInfo),
                i, j, parent;
            for (i = 0; i &lt; parentsAndMe.length; i++) {
                parent = parentsAndMe[i];
                if (parent.collisions) {
                    for (j in parent.collisions) {
                        if (colls[j]) {
                            colls[j].push(parent.collisions[j]);
                        } else {
                            colls[j] = [parent.collisions[j]];
                        }
                    }
                }
            }
            for (i in colls) {
                if (colls[i].length === 1) { //one handler for the collision
                    colls[i] = colls[i][0];
                } else {
                    colls[i] = createBatchFunction(colls[i]);
                }
            }
        }
    });

    function createBatchFunction(fns) { //todov2 optimize (compile)
        var i;
        return function () {
            for (i = 0; i &lt; fns.length; i++) {
                fns[i].apply(this, arguments);
            }
        };
    }

    function createPartition(instances, blockSize) {
        var partition = {
                size: instances.length
            },
            id, instance, bounds, boundsArray, leftCell, rightCell, bottomCell, topCell, i, j, cellItems, cellHash;

        for (id = instances.length - 1; id &gt;= 0; id--) {
            instance = instances[id];
            bounds = instance.getBounds();
            boundsArray = [bounds.left, bounds.right, bounds.top, bounds.bottom];
            leftCell = (boundsArray[0] / blockSize) &gt;&gt; 0;
            rightCell = (boundsArray[1] / blockSize) &gt;&gt; 0;
            topCell = (boundsArray[2] / blockSize) &gt;&gt; 0;
            bottomCell = (boundsArray[3] / blockSize) &gt;&gt; 0;
            for (i = leftCell; i &lt;= rightCell; ++i) {
                for (j = topCell; j &lt;= bottomCell; ++j) {
                    if (!(cellItems = partition[cellHash = i + &#x27;;&#x27; + j])) { //no cell list
                        partition[cellHash] = [
                            [instance, boundsArray]
                        ];
                    } else {
                        cellItems.push([instance, boundsArray]);
                    }
                }
            }
        }
        return partition;
    }

    /**
     * A system, which handles broad phase collision detection of Collidable instances added to the system&#x27;s layer.
     * It uses spatial partitioning algorithm, creating a partition for each class and tag only if they have collision
     * event handler. Note that the collision system gets the instances of the layer directly, not through an event
     * emission, so instances in sub-layers won&#x27;t collide.
     *
     * @class Grape.CollisionSystem
     * @uses Grape.System
     */
    var CollisionSystem = Class(&#x27;CollisionSystem&#x27;, System, {
        init: function (settings) {
            settings = settings || {};
            this.blockSize = settings.blockSize || 64;
            this.ClassPartition = function () {
            };

            this.TagPartition = function () {
            };
        },
        /**
         * (Re)creates a partition table for a class or a tag. This table is used to check collision until removed.
         *
         * @method createStaticPartition
         * @param {String|Class} name Tag or class
         */
        createStaticPartition: function (name) {
            if (name.id) {//class
                this.ClassPartition.prototype[name.id] = createPartition(this._layer._get(name), this.blockSize); //store static partition in prototype to speed up the lookup
            } else {//tag
                this.TagPartition.prototype[name] = createPartition(this._layer._getTag(name), this.blockSize); //store static partition in prototype to speed up the lookup
            }
        },
        /**
         * Removes a partition table for a class or a tag.
         *
         * @method removeStaticPartition
         * @param {String|Class} name Tag or class
         */
        removeStaticPartition: function (name) {
            if (name.id) {//class
                delete this.ClassPartition.prototype[name.id];
            } else {//tag
                delete  this.TagPartition.prototype[name];
            }
        },
        &#x27;event frame&#x27;: function () {
            //collision is defined between classes and tags
            var classes = this._layer._getClasses(Collidable),
                partitionsByTag = new this.TagPartition(),
                partitionsByClass = new this.ClassPartition(),
                list = [],
                classId, tagName, colls, instances, hasRealTarget, i, j, k, l, item, emitted, part1, part2, handler, invert, bigger, smaller, cell1, cell2, inst1, inst2, key, box1, box2;
            for (classId in classes) {
                colls = classes[classId].clazz.allCollision;
                hasRealTarget = false;
                for (tagName in colls) {
                    if (!partitionsByTag[tagName]) {
                        instances = this._layer._tags[tagName];
                        if (instances &amp;&amp; instances.length !== 0) {
                            partitionsByTag[tagName] = createPartition(instances, this.blockSize);
                            hasRealTarget = true;
                            list.push([classId, tagName, colls[tagName]]);
                        }
                    } else {
                        hasRealTarget = true;
                        list.push([classId, tagName, colls[tagName]]);
                    }
                }
                if (hasRealTarget &amp;&amp; !partitionsByClass[classId]) {
                    partitionsByClass[classId] = createPartition(classes[classId].instances, this.blockSize);
                }
            }

            for (i = 0; i &lt; list.length; i++) {
                item = list[i];
                emitted = {};
                part1 = partitionsByClass[item[0]];
                part2 = partitionsByTag[item[1]];
                handler = item[2];

                if (invert = part1.size &gt; part2.size) {
                    bigger = part1;
                    smaller = part2;
                } else {
                    bigger = part2;
                    smaller = part1;
                }

                for (j in smaller) {
                    if (j === &#x27;size&#x27; || !bigger[j]) { //other partition does not contain the cell
                        continue;
                    }

                    cell1 = invert ? bigger[j] : smaller[j];
                    cell2 = invert ? smaller[j] : bigger[j];
                    for (k = cell1.length - 1; k &gt;= 0; --k) {
                        inst1 = cell1[k];
                        for (l = cell2.length - 1; l &gt;= 0; --l) {
                            inst2 = cell2[l];
                            if (inst1[0] === inst2[0]) { //same instance
                                continue;
                            }
                            key = inst1[0].collisionId + &#x27;-&#x27; + inst2[0].collisionId;
                            if (emitted[key]) {
                                continue;
                            }
                            box1 = inst1[1];
                            box2 = inst2[1];
                            if (box1[1] &gt; box2[0] &amp;&amp; box2[1] &gt; box1[0] &amp;&amp; box1[3] &gt; box2[2] &amp;&amp; box2[3] &gt; box1[2]) { //intersect
                                handler.call(inst1[0], inst2[0]);
                                emitted[key] = true;
                            }
                        }
                    }
                }
            }
        }
    });

    var nextId = 0;
    /**
     * A class, which can have collision events.
     *
     * @class Grape.Collidable
     * @uses Grape.GameObject
     * @uses Grape.AABB
     */
    var Collidable = Class(&#x27;Collidable&#x27;, [GameObject, AABB], {
        init: function () {
            this.collisionId = nextId++;
        },
        &#x27;abstract getBounds&#x27;: null,
        &#x27;abstract getLeft&#x27;: null,
        &#x27;abstract getTop&#x27;: null,
        &#x27;abstract getRight&#x27;: null,
        &#x27;abstract getBottom&#x27;: null,
        &#x27;abstract getWidth&#x27;: null,
        &#x27;abstract getHeight&#x27;: null
    });

    return {
        Collidable: Collidable,
        CollisionSystem: CollisionSystem
    };
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
