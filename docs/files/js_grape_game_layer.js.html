<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js\grape\game\layer.js - grape</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="grape"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Grape.html">Grape</a></li>
            
                <li><a href="../classes/Grape.AABB.html">Grape.AABB</a></li>
            
                <li><a href="../classes/Grape.AbstractView.html">Grape.AbstractView</a></li>
            
                <li><a href="../classes/Grape.Alarm.html">Grape.Alarm</a></li>
            
                <li><a href="../classes/Grape.Animation.html">Grape.Animation</a></li>
            
                <li><a href="../classes/Grape.Array.html">Grape.Array</a></li>
            
                <li><a href="../classes/Grape.Audio.html">Grape.Audio</a></li>
            
                <li><a href="../classes/Grape.Bag.html">Grape.Bag</a></li>
            
                <li><a href="../classes/Grape.Cacheable.html">Grape.Cacheable</a></li>
            
                <li><a href="../classes/Grape.Class.html">Grape.Class</a></li>
            
                <li><a href="../classes/Grape.Collidable.html">Grape.Collidable</a></li>
            
                <li><a href="../classes/Grape.CollisionSystem.html">Grape.CollisionSystem</a></li>
            
                <li><a href="../classes/Grape.Env.html">Grape.Env</a></li>
            
                <li><a href="../classes/Grape.EventEmitter.html">Grape.EventEmitter</a></li>
            
                <li><a href="../classes/Grape.Game.html">Grape.Game</a></li>
            
                <li><a href="../classes/Grape.GameLoop.html">Grape.GameLoop</a></li>
            
                <li><a href="../classes/Grape.GameObject.html">Grape.GameObject</a></li>
            
                <li><a href="../classes/Grape.GameObjectArray.html">Grape.GameObjectArray</a></li>
            
                <li><a href="../classes/Grape.GUIView.html">Grape.GUIView</a></li>
            
                <li><a href="../classes/Grape.Input.html">Grape.Input</a></li>
            
                <li><a href="../classes/Grape.JSONSceneSource.html">Grape.JSONSceneSource</a></li>
            
                <li><a href="../classes/Grape.Layer.html">Grape.Layer</a></li>
            
                <li><a href="../classes/Grape.Mouse.html">Grape.Mouse</a></li>
            
                <li><a href="../classes/Grape.Object.html">Grape.Object</a></li>
            
                <li><a href="../classes/Grape.Physical.html">Grape.Physical</a></li>
            
                <li><a href="../classes/Grape.Position.html">Grape.Position</a></li>
            
                <li><a href="../classes/Grape.Rectangle.html">Grape.Rectangle</a></li>
            
                <li><a href="../classes/Grape.Resource.html">Grape.Resource</a></li>
            
                <li><a href="../classes/Grape.ResourceCollection.html">Grape.ResourceCollection</a></li>
            
                <li><a href="../classes/Grape.Scene.html">Grape.Scene</a></li>
            
                <li><a href="../classes/Grape.Sprite.html">Grape.Sprite</a></li>
            
                <li><a href="../classes/Grape.SpriteVisualizer.html">Grape.SpriteVisualizer</a></li>
            
                <li><a href="../classes/Grape.System.html">Grape.System</a></li>
            
                <li><a href="../classes/Grape.TagContainer.html">Grape.TagContainer</a></li>
            
                <li><a href="../classes/Grape.Taggable.html">Grape.Taggable</a></li>
            
                <li><a href="../classes/Grape.Utils.html">Grape.Utils</a></li>
            
                <li><a href="../classes/Grape.View.html">Grape.View</a></li>
            
                <li><a href="../classes/Grape.Visualizer.html">Grape.Visualizer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js\grape\game\layer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([
    &#x27;../class&#x27;,
    &#x27;../etc/event-emitter&#x27;,
    &#x27;../etc/tag&#x27;,
    &#x27;./game-object&#x27;,
    &#x27;./game-object-array&#x27;,
    &#x27;../utils&#x27;,
    &#x27;../collections/bag&#x27;
], function (Class, EventEmitter, Tag, GameObject, GameObjectArray, Utils, Bag) {

    function addWithOrWithoutName(target, name, object) {
        if (object === undefined) { //no name
            object = name;
            target.push(object);
        } else {
            if (target[name]) {
                throw new Error(&#x27;Element &quot;&#x27; + name + &#x27;&quot; already added.&#x27;);
            }
            target[name] = object;
        }
        return object;
    }

    function remove(target, name) {
        if (typeof  name === &#x27;string&#x27;) { //by name
            if (!target[name]) {
                throw new Error(&#x27;Element &quot;&#x27; + name + &#x27;&quot; does not exist.&#x27;);
            }
            delete target[name];
        } else { //by object
            if (!Utils.removeFromArray(target, name)) {
                throw new Error(&#x27;Element does not exist.&#x27;);
            }
        }
    }

    /**
     * A layer contains instances, systems, and other layers.
     * When any event is emitted to the layer, it is emitted to the systems and layers of the layer too.
     * When you want to subscribe to the layer events with a GameObject (which is added to the layer) you can use the
     * gameObject.onGlobal() function or the global-event keyword.
     *
     * @class Grape.Layer
     * @uses Grape.EventEmitter
     * @uses Grape.TagContainer
     * @constructor
     * @param {Object} opts Initial properties
     */
    return Class(&#x27;Layer&#x27;, [EventEmitter, Tag.TagContainer], {
        init: function (opts) {
            opts = opts || {};
            this.width = opts.widht || 400;
            this.height = opts.height || 300;
            this.background = opts.background || null;
            this.backgroundColor = opts.backgroundColor || null;

            this._classes = {};
            this._activeClasses = {};

            this.instanceNumber = 0;
            this._layers = [];
            this._systems = [];

            this._parentLayer = null;
        },
        /**
         * Adds an instance to the layer and emits it&#x27;s &quot;add&quot; event.
         *
         * @method add
         * @param {Grape.GameObject} instance Instance
         * @return {Grape.GameObject} The added instance
         */
        add: function (instance) {
            var i, classData, parentId, clazz = instance.getClass(), classId = clazz.id, allParent;
            if (!instance.instanceOf(GameObject)) {
                throw new Error(&#x27;The instance must be a descendant of Grape.GameObject.&#x27;);
            }
            instance.setTagContainer(this);
            instance._layer = this;

            if (!(classData = this._classes[classId])) { //instance class is not registered yet
                this._activeClasses[classId] = this._classes[classId] = classData = {
                    id: classId,
                    clazz: clazz,
                    instances: new Bag(),
                    instanceNumber: 1,
                    descendants: []
                };
                allParent = clazz.allParent;
                for (i = allParent.length; --i &gt;= 0;) {
                    parentId = allParent[i].id;
                    if (!this._classes[parentId]) { //parent type is not registered yet
                        this._classes[parentId] = {
                            id: parentId,
                            clazz: allParent[i],
                            instances: new Bag(),
                            instanceNumber: 0,
                            descendants: [classData]
                        };
                    } else {
                        this._classes[parentId].descendants.push(classData);
                    }
                }
            } else {
                this._activeClasses[classId] = classData; //set class active
                classData.instanceNumber++;
            }
            this.instanceNumber++;
            instance._index = classData.instances.add(instance) - 1; //store the index in the bag for efficient remove

            /**
             * This event is emitted to the instance when it is added to the layer. The parameter is the layer.
             *
             * @event add (instance)
             */
            instance.emit(&#x27;add&#x27;, this);
            return instance;
        },
        /**
         * Removes an instance from the layer and emits it&#x27;s &quot;remove&quot; event.
         *
         * @method remove
         * @param instance
         */
        remove: function (instance) {
            var clazz = instance.getClass(), classId = clazz.id, typeData = this._classes[classId], instances = this._activeClasses[classId].instances, idx = instance._index, moved = instances.remove(idx);
            if (moved) {
                moved._index = idx; //update the index of the item moved to the position of the removed item
            }
            typeData.instanceNumber -= 1;
            if (typeData.instanceNumber === 0) {
                delete this._activeClasses[classId];
            }
            this.instanceNumber--;
            instance.removeTagContainer();

            /**
             * Emitted to the instance when it is removed from the layer.
             *
             * @event remove (instance)
             */
            instance.emit(&#x27;remove&#x27;);
        },
        /**
         * Returns the instances with the given tag. Instances are indexed by tags.
         *
         * @method getByTag
         * @return {Grape.GameObjectArray} Instances with the tag
         */
        getByTag: function (/*tag1, tag2, ...*/) {
            return this.parent(Tag.TagContainer, &#x27;get&#x27;).apply(this, arguments);
        },
        /**
         * Overrides the TagContainer&#x27;s method so getByTag calls produce GameObjectArray results instead of Array.
         *
         * @method createResultContainer
         * @return {Grape.GameObjectArray}
         */
        &#x27;override createResultContainer&#x27;: function () {
            return new GameObjectArray();
        },
        _getClasses: function (parent) {
            var result = {}, classData = this._classes[parent.id], i, desc;
            if (classData) {
                if (this._activeClasses[classData.id]) {
                    result[classData.id] = classData;
                }
                for (i = 0; i &lt; classData.descendants.length; i++) {
                    desc = classData.descendants[i];
                    if (this._activeClasses[desc.id]) {
                        result[desc.id] = desc;
                    }
                }
            }
            return result;
        },
        _get: function (clazz) {
            var instances = this._activeClasses[clazz.id];
            if (instances) {
                return instances.instances;
            }
            return [];
        },
        /**
         * Gets the instances of one or more class in the current layer (sub-layers not included).
         *
         * @method get
         * @param {Class|Array} classes Class or classes
         * @param {Boolean} [descendants=false] Get the descendants of that class or just instances of the class itself
         * @return {GameObjectArray} Instances
         */
        get: function (classes, descendants) {
            var i, j, instances,
                classData, classDataArr = [], addedClasses = {}, result = new GameObjectArray();

            function addIfNotAdded(cd) {
                if (addedClasses[cd.id]) {
                    return;
                }
                addedClasses[cd.id] = true;
                instances = cd.instances;
                for (i = instances.length; i-- &gt; 0;) { //todov2 use this loop everywhere if possible
                    result.push(instances[i]);
                }
            }

            if (classes) {
                if (!Utils.isArray(classes)) {
                    classes = [classes];
                }
                for (i = 0; i &lt; classes.length; i++) {
                    classData = this._classes[classes[i].id];
                    if (classData) {
                        classDataArr.push(classData);
                    }
                }
            } else {
                /*jshint -W088 */ //due an issue: https://github.com/jshint/jshint/issues/1016
                for (i in this._activeClasses) {
                    classDataArr.push(this._activeClasses[i]);
                }
            }
            for (i = 0; i &lt; classDataArr.length; i++) {
                classData = classDataArr[i];
                addIfNotAdded(classData);
                if (descendants) {
                    descendants = classData.descendants;
                    for (j = 0; j &lt; descendants.length; j++) {
                        addIfNotAdded(descendants[j]);
                    }
                }
            }
            return result;
        },
        /**
         * Adds a sub-layer to the current layer.
         *
         * @method addLayer
         * @param {String} [name] Layer name
         * @param {Grape.Layer} layer Sub-layer
         */
        addLayer: function (name, layer) {
            layer = addWithOrWithoutName(this._layers, name, layer);
            layer._parentLayer = this;
            /*TODOv2 needed? if (this._started) {
             layer.emit(&#x27;start&#x27;);
             }*/
        },
        /**
         * Adds a system to the layer. All events are emitted to all added systems.
         *
         * @method addSystem
         * @param {String} [name] Name
         * @param {Grape.System} system The system
         */
        addSystem: function (name, system) { //todov2 add without name
            system = addWithOrWithoutName(this._systems, name, system);
            system._layer = this;
            if (this._started) {
                /**
                 * Emitted to a system when it is added to a running layer or when the layer is started with a system
                 * added before.
                 *
                 * @event start (system)
                 */
                system.emit(&#x27;start&#x27;);
            }
        },
        /**
         * Adds a view to the layer. A synonym for addSystem.
         *
         * @method addView
         * @param {String} name View name
         * @param {Grape.View} view The view
         */
        addView: function (name, view) { //todv2o create with view class if config object is given
            this.addSystem(name, view);
        },
        /**
         * Removes a layer.
         *
         * @method removeLayer
         * @param {String|Grape.Layer} name Name of the layer or the layer itself
         */
        removeLayer: function (name) { //todov2 stop event?
            remove(this._layers, name);
        },
        /**
         * Removes a system from the layer.
         *
         * @method removeSystem
         * @param {String|Grape.System} system The name of the system or the system itself.
         */
        removeSystem: function (system) {
            system = remove(this._systems, system);
            if (this._started) {
                /**
                 * Emitted to a system when it is removed from the running layer or when the layer is stopped.
                 *
                 * @event stop (system)
                 */
                system.emit(&#x27;stop&#x27;);
            }
        },
        /**
         * Removes a view from the layer. An alias for removeSystem.
         *
         * @method removeView
         * @param {String|Grape.View} name View name or the view itself
         */
        removeView: function (name) {
            this.removeSystem(name);
        },
        /**
         * Returns a system with the given name. Views are also considered as systems.
         *
         * @method getSystem
         * @param {String} name System name
         * @return {Grape.System} System
         */
        getSystem: function (name) {
            return this._systems[name];
        },
        /**
         * Returns the root layer.
         *
         * @method getScene
         * @return {Grape.Scene} The root layer
         */
        getScene: function () {
            if (this._parentLayer) {
                return this._parentLayer.getScene();
            }
            return this;
        },
        /**
         * Returns the current game.
         *
         * @method getGame
         * @return {Grape.Game} The game
         */
        getGame: function () {
            return this.getScene()._game;
        },
        &#x27;event start&#x27;: function () {
            this._started = true;
        },
        &#x27;event render&#x27;: function (ctx) {
            if (this.backgroundColor) {
                ctx.fillStyle = this.backgroundColor;
                ctx.fillRect(0, 0, this.width, this.height);
            }
            if (this.background) {
                var pattern = ctx.createPattern(this.background.img, &#x27;repeat&#x27;); //TODOv2 create function for bg drawing
                ctx.rect(0, 0, this.width, this.height);
                ctx.fillStyle = pattern;
                ctx.fill();
                ctx.fillStyle = &#x27;&#x27;;
            }
        },
        &#x27;event any&#x27;: function (event, payload) {
            var i;
            for (i in this._layers) {
                this._layers[i].emit(event, payload);
            }
            for (i in this._systems) {
                this._systems[i].emit(event, payload);
            }
        }
    });
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
